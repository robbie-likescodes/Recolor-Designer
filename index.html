<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Palette Mapper · Cup Print Helper</title>
  <link rel="stylesheet" href="styles.css" />
  <meta name="theme-color" content="#0f172a">
</head>
<body>
<header class="topbar">
  <div class="brand">
    <span class="logo" aria-hidden="true">☕</span>
    <h1>Palette Mapper</h1>
  </div>
  <div class="spacer"></div>
  <button id="openProjects" class="ghost" type="button">Projects</button>
</header>

<!-- Projects pane -->
<aside id="projectsPane" class="sidepane" aria-hidden="true">
  <div class="panehead">
    <h2>Projects</h2>
    <button id="closeProjects" class="ghost" type="button" aria-label="Close">✕</button>
  </div>
  <div class="panecontent">
    <div class="row wrap gap">
      <button id="saveProject" type="button">Save current</button>
      <button id="refreshProjects" type="button">Refresh list</button>
    </div>

    <div id="projectsList" class="list" aria-label="Saved projects"></div>

    <hr>

    <div class="row wrap gap">
      <button id="exportProject" type="button">Export selected</button>
      <label class="filelike">Import
        <input type="file" id="importProject" accept="application/json">
      </label>
      <button id="deleteProject" class="danger" type="button">Delete selected</button>
    </div>
  </div>
</aside>

<main>
  <section class="controls">
    <!-- 1) Load image -->
    <div class="card">
      <h2>1) Load image</h2>
      <div class="row wrap">
        <!-- Gives Photo Library + Camera chooser -->
        <label class="filelike">Upload
          <input type="file" id="fileInput" accept="image/*">
        </label>
        <!-- Forces Camera only (optional) -->
        <label class="filelike">Camera
          <input type="file" id="cameraInput" accept="image/*" capture="environment">
        </label>
        <button id="pasteBtn" type="button" title="Paste image from clipboard (desktop)">Paste</button>
        <button id="resetBtn" type="button" disabled>Reset</button>
      </div>

      <div class="row wrap">
        <label>Max preview width (px)
          <input type="number" id="maxW" value="1400" min="300" step="100">
        </label>
        <label class="chk">
          <input type="checkbox" id="keepFullRes" checked>
          Process at full resolution
        </label>
      </div>
      <small>“Upload” lets you choose from Photo Library or Camera on iOS. “Camera” forces the camera only.</small>
    </div>

    <!-- 2) Palette -->
    <div class="card">
      <h2>2) Palette</h2>
      <div id="paletteList" class="palette-list"></div>
      <div class="row gap wrap">
        <button id="addColor" type="button">+ Add color</button>
        <button id="clearColors" type="button">Clear</button>
        <button id="loadExample" type="button">Load example</button>
      </div>

      <details>
        <summary>Auto-extract from image (optional)</summary>
        <div class="row gap wrap">
          <label>K (colors) <input type="number" id="kColors" value="5" min="2" max="16"></label>
          <button id="autoExtract" type="button" disabled>Extract</button>
        </div>
        <small>The app now auto-builds a 10-color palette after you upload. Use this extractor if you want a different K.</small>
      </details>

      <div class="card subtle">
        <h3>Saved Palettes</h3>
        <div id="savedPalettes" class="list tiny" aria-label="Saved palettes"></div>
        <div class="row gap wrap">
          <button id="savePalette" type="button">Save current</button>
          <button id="clearSavedPalettes" type="button">Clear saved</button>
        </div>
      </div>
    </div>

    <!-- 3) Mapping options -->
    <div class="card">
      <h2>3) Mapping options</h2>

      <div class="row">
        <label>Chroma weight
          <input type="range" id="wChroma" min="50" max="200" value="100">
        </label>
        <output id="wChromaOut">1.00×</output>
      </div>

      <div class="row">
        <label>Lightness weight
          <input type="range" id="wLight" min="50" max="200" value="100">
        </label>
        <output id="wLightOut">1.00×</output>
      </div>

      <div class="row wrap">
        <label class="chk"><input type="checkbox" id="useDither"> Floyd–Steinberg dithering</label>
        <label>Background
          <select id="bgMode">
            <option value="keep">Keep alpha</option>
            <option value="white">Force white</option>
            <option value="transparent">Force transparent (alpha &lt; 128)</option>
          </select>
        </label>
      </div>

      <div class="card subtle">
        <h3>Halftone (tiny dots)</h3>
        <label class="chk">
          <input type="checkbox" id="useHalftone">
          Render as dots instead of pixels
        </label>

        <div class="row wrap">
          <label>Dot cell size (px)
            <input type="number" id="dotCell" value="6" min="3" max="64" step="1">
          </label>
          <label>Background
            <input type="text" id="dotBg" value="#FFFFFF" placeholder="#RRGGBB">
          </label>
          <label class="chk">
            <input type="checkbox" id="dotJitter">
            Jitter positions slightly
          </label>
        </div>
        <small>Each cell becomes a dot of the nearest palette color, sized by coverage vs background.</small>
      </div>

      <div class="row gap wrap">
        <button id="applyBtn" type="button" disabled>Refresh with my color selection</button>
        <button id="downloadBtn" type="button" disabled>Download PNG</button>
        <button id="openEditor" type="button">Open full-screen editor</button>
      </div>
    </div>

    <!-- Legacy rectangle region section (kept for IDs, hidden by JS) -->
    <div class="card">
      <h2>Region tool (optional)</h2>
      <div class="row wrap">
        <label class="chk"><input type="checkbox" id="regionMode"> Draw rectangle region (drag on Original)</label>
        <button id="regionClear" type="button" class="ghost">Clear all regions</button>
      </div>
      <div id="regionConfig" class="region-config" hidden>
        <h3>Region palette</h3>
        <div id="regionPaletteChecks"></div>
        <div class="row gap">
          <button id="regionApply" type="button">Save region</button>
          <button id="regionCancel" type="button" class="ghost">Cancel</button>
        </div>
        <small>Uncheck colors you do <em>not</em> want in this rectangle.</small>
      </div>
    </div>
  </section>

  <section class="canvases">
    <div class="canvas-card">
      <h3>Original</h3>
      <div class="canvas-wrap">
        <canvas id="srcCanvas" tabindex="0" aria-label="Original image preview"></canvas>
      </div>
      <small>Press & hold to pick a color in the full-screen editor. On desktop, ALT-click works on this preview.</small>
    </div>

    <div class="canvas-card">
      <h3>Mapped</h3>
      <div class="canvas-wrap">
        <canvas id="outCanvas" tabindex="0" aria-label="Palette-mapped / halftoned image"></canvas>
      </div>
    </div>
  </section>
</main>

<footer>
  <p>Palette Mapper · Mobile-friendly · Works offline</p>
</footer>

<!-- Full-screen Editor -->
<div id="editorOverlay" class="editor hidden" aria-hidden="true">
  <div class="editor-left">
    <div class="editor-toolbar">
      <button id="toolEyedrop" type="button" class="tool active">Eyedropper</button>
      <button id="toolLasso"   type="button" class="tool">Lasso</button>
      <button id="toolPan"     type="button" class="tool">Pan</button>
      <div class="spacer"></div>
      <button id="editorDone"  type="button" class="ghost">Done</button>
    </div>
    <div class="editor-canvas-wrap">
      <canvas id="editCanvas"></canvas>
      <canvas id="editOverlay"></canvas>
    </div>
  </div>

  <aside class="editor-right">
    <h3>Palette</h3>
    <div id="editorPalette" class="editor-palette"></div>
    <hr>
    <h3>Region restrictions (lasso)</h3>
    <small>Uncheck colors you do <em>not</em> want inside the lasso.</small>
    <div id="lassoChecks" class="editor-checks"></div>
    <div class="row gap">
      <button id="lassoSave" type="button" disabled>Save region</button>
      <button id="lassoClear" type="button" class="ghost" disabled>Clear</button>
    </div>
    <hr>
    <h3>Eyedropper preview</h3>
    <div class="eye-preview">
      <span id="eyeSwatch" class="sw"></span>
      <code id="eyeHex">#000000</code>
    </div>
    <div class="row gap">
      <button id="eyeAdd" type="button">Add to palette</button>
      <button id="eyeCancel" type="button" class="ghost">Cancel</button>
    </div>
  </aside>
</div>

<script src="app.js"></script>
</body>
</html>
